<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"/>
        <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Aclonica&family=Six+Caps&display=swap" rel="stylesheet">
        <script src="//d3js.org/d3.v3.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
        <link rel="stylesheet" href="style.css">
    </head>
    

<body>
    <div class="hero-image">
        <div class="hero-text">
            <header>Titanic: Sink or Swim?</header>
        </div>
    </div>
    <nav>
        <ul>
            <li>
                <a class="backtitle" href="index.html" top:30px>
                <i class="fas fa-user-circle"></i> Go Back</a>
            </li>
        </ul>
    </nav>

</section>
<section id="zoom">

    <div class="bigbox2">
        <h1>Zoom Chart</h1>
        <div class="filters">
            <label for="gender">Filter by gender:</label>
            <select name="gender" id="gender">
                <option></option>
                <option value="female">Female</option>
                <option value="male">Male</option>
            </select>
        
            <label for="age">Filter by age:</label>
        
            <select name="age" id="age">
                <option></option>
                <option value="Over 30">Over 30</option>
                <option value="30 and under">30 and under</option>
            </select>
        
            <label for="survived">Filter by survival:</label>
        
            <select name="survived" id="survived">
                <option></option>
                <option value="yes">Survived</option>
                <option value="no">Did not survive</option>
            </select>
            <div class="image-test">
                <button>Reset Zoom</button>
            </div>
            <div class="zoomcircles"> </div>
            <div class="tooltip">
                <span class="tooltiptext"></span>
            </div>
    </div>
        
</section>
<script type="text/javascript">
    d3.csv("titanic passenger list (2).csv", data => {

        //console.log("DATA: ", data)
        createSymbolChart(data)

        // d3.selectAll('circle')
        //      .on('click', function (d, i) {
        //          d3.select(this)
        //              .style('fill', 'orange');
        //      });
        // d3.selectAll('circle')
        // .on("mouseover", function(d, i){
        //     d3.select(this)
        //     .append("text")
        //     .style("fill", "gray")
        // })



        let agetype = document.querySelector("#age")


        d3.select('#gender')
            .on("change", function (d) {
                let gendertype = document.querySelector("#gender").value
                console.log("gender: ", gendertype)
                var newdata = data.filter(function (d) {
                    console.log("d in filter: ", d)
                    if (d.sex.toLowerCase() == gendertype) {
                        console.log("d: ", d)
                        return d;
                    } else if (gendertype == "") {
                        return d;
                    }
                })
                console.log("DATA NEW: ", newdata)
                createSymbolChart(newdata);
            });

        d3.select('#survived')
            .on("change", function (d) {
                let survivaltype = document.querySelector("#survived").value
                if (survivaltype == "Survived") {
                    var newdata = data.filter(function (d) {
                        if (d.survived > 0) {
                            return d;
                        } else if (survivaltype == "") {
                            return d;
                        }
                    })
                } else {
                    var newdata = data.filter(function (d) {
                        if (d.survived < 1) {
                            return d;
                        } else if (survivaltype == "") {
                            return d;
                        }
                    })
                }
                createSymbolChart(newdata);
            });

        d3.select('#age')
            .on("change", function (d) {
                let agegroup = document.querySelector("#age").value

                var newdata = data.filter(function (d) {
                    //console.log("d in filter: ", d)
                    if (d.age_category == agegroup) {
                        return d;
                    } else if (agegroup == "") {
                        return d;
                    }
                })
                createSymbolChart(newdata);
            });


        d3.select("#sort-btn")
            .on("click", function (d) {
                sorted += 1;
                update(data, type, sorted)
            })
        var selected = d3.selectAll("#selected")
            .append("text")
            .text("oooo")
            .attr("fill", "white")



        console.log("selected: ", selected)

    })// end of csv call



    function createSymbolChart(data) {

        d3.selectAll("circle")
            .transition()
            .duration(1000)
            .remove()

        d3.select("svg")
            .remove()

        var height = 600;
        var width = 1000;
        var scale = 1.0;

        var zoom = d3.behavior.zoom()
            .scale(scale)
            .scaleExtent([1, 5])
        // .on("zoom", zoomed);

        var svg = d3.select(".zoomcircles").append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("margin-left", 200)
            .call(zoom);


        var container = svg.append("g")
            .attr("id", "container")
            .attr("margin-left", 200)
            .attr("transform", "translate(0,0)scale(1,1)");

        var bbox, viewBox, vx, vy, vw, vh, defaultView;

        var clickScale = 33.0;		// scale used when circle is clicked
        d3.select("button").on("click", reset);

        // circle = container.append("g")
        //     .attr("id", "circles")
        //     .selectAll("circle")
        //     .data(circles)

        var div = d3.select(".tooltiptext").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0);

        var dots = container.append("g")
            .attr("id", "circles")
            .selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", function (d, i) {

                if (i < 50) {
                    return (i + 1) * 18;
                }
                else if (i < 100) {
                    return (i - 50 + 1) * 18;
                }
                else if (i < 150) {
                    return (i - 100 + 1) * 18;
                }
                else if (i < 200) {
                    return (i - 150 + 1) * 18;
                }
                else if (i < 250) {
                    return (i - 200 + 1) * 18;
                }
                else if (i < 300) {
                    return (i - 250 + 1) * 18;
                }
                else if (i < 350) {
                    return (i - 300 + 1) * 18;
                }
                else if (i < 400) {
                    return (i - 350 + 1) * 18;
                }
                else if (i < 450) {
                    return (i - 400 + 1) * 18;
                }
                else if (i < 500) {
                    return (i - 450 + 1) * 18;
                }
                else if (i < 550) {
                    return (i - 500 + 1) * 18;
                }
                else if (i < 600) {
                    return (i - 550 + 1) * 18;
                }
                else if (i < 650) {
                    return (i - 600 + 1) * 18;
                }
                else if (i < 700) {
                    return (i - 650 + 1) * 18;
                }
                else if (i < 750) {
                    return (i - 700 + 1) * 18;
                }
                else if (i < 800) {
                    return (i - 750 + 1) * 18;
                }
                else if (i < 850) {
                    return (i - 800 + 1) * 18;
                }
                else if (i < 900) {
                    return (i - 850 + 1) * 18;
                }
                else if (i < 950) {
                    return (i - 900 + 1) * 18;
                }
                else if (i < 1000) {
                    return (i - 950 + 1) * 18;
                }
                else if (i < 1050) {
                    return (i - 1000 + 1) * 18;
                }
                else if (i < 1100) {
                    return (i - 1050 + 1) * 18;
                }
                else if (i < 1150) {
                    return (i - 1100 + 1) * 18;
                }
                else if (i < 1200) {
                    return (i - 1150 + 1) * 18;
                }
                else if (i < 1250) {
                    return (i - 1200 + 1) * 18;
                }
                else if (i < 1300) {
                    return (i - 1250 + 1) * 18;
                }
                else {
                    return (i - 1300 + 1) * 18;
                }

            })
            .attr("cy", function (d, i) {
                //console.log("I: ", i)
                if (i < 50) {
                    return 10;
                }
                else if (i < 100) {
                    return 30;
                }
                else if (i < 150) {
                    return 50
                }
                else if (i < 200) {
                    return 70
                }
                else if (i < 250) {
                    return 90
                }
                else if (i < 300) {
                    return 110
                }
                else if (i < 350) {
                    return 130
                }
                else if (i < 400) {
                    return 150
                }
                else if (i < 450) {
                    return 170
                }
                else if (i < 500) {
                    return 190
                }
                else if (i < 550) {
                    return 210
                }
                else if (i < 600) {
                    return 230
                }
                else if (i < 650) {
                    return 250
                }
                else if (i < 700) {
                    return 270
                }
                else if (i < 750) {
                    return 290
                }
                else if (i < 800) {
                    return 310
                }
                else if (i < 850) {
                    return 330
                }
                else if (i < 900) {
                    return 350
                }
                else if (i < 950) {
                    return 370
                }
                else if (i < 1000) {
                    return 390
                }
                else if (i < 1050) {
                    return 410
                }
                else if (i < 1100) {
                    return 430
                }
                else if (i < 1150) {
                    return 450
                }
                else if (i < 1200) {
                    return 470
                }
                else if (i < 1250) {
                    return 490
                }
                else if (i < 1300) {
                    return 510
                }
                else {
                    return 530
                }
            })
            .attr("r", 8)
            .attr("fill", function (d) {
                if (d.pclass == "1") {
                    return "gold"
                }
                else if (d.pclass == "2") {
                    return "lightblue"
                }
                else if (d.pclass == "3") {
                    return "pink"
                }
                else {
                    return "brown"
                }
            })
            .on("click", clicked)
            .on("mouseover", function (d) {
                console.log("over: ", d)
                
                d3.select(this).attr("fill","MediumSlateBlue")
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html(d.name_readable + "<br/>" + d.sex)
                // .style("left", (d3.event.pageX) + "px")		
                // .style("top", (d3.event.pageY - 28) + "px");	
            })
            .on("mouseout", function (d) {
                d3.select(this).attr("fill", function(d){
                    if (d.pclass==1){
                        return "gold"
                    }
                    else if (d.pclass == 2) {
                        return "lightblue"
                    }
                    else if (d.pclass == 3) {
                        return "pink"
                    }
                })
                // var color = d3.select(this).attr("fill",)
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
            
        d3.selectAll('g.item')
            .append('text')
            .text(function (d, i) {
                return i + 1;
            });

        // dots.append("text")
        
        //     .text(function (d) {
        //         //console.log("appending text", d)
        //         return d.pclass
        //     })
        //     .attr("cx", function (d, i) {
        //         10 * i;
        //     })
        //     .attr("cy", function (d, i) {
        //         10 * i;
        //     })
        //     .attr("fill", "black")


        bbox = container.node().getBBox();
        vx = bbox.x;		// container x co-ordinate
        vy = bbox.y;		// container y co-ordinate
        vw = bbox.width;	// container width
        vh = bbox.height;	// container height
        defaultView = "" + vx + " " + vy + " " + vw + " " + vh;
        svg
            .attr("viewBox", defaultView)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .call(zoom);

        function getTransform(node, xScale) {
            bbox = node.node().getBBox();
            var bx = bbox.x;
            var by = bbox.y;
            var bw = bbox.width;
            var bh = bbox.height;
            var tx = -bx * xScale + vx + vw / 2 - bw * xScale / 2;
            var ty = -by * xScale + vy + vh / 2 - bh * xScale / 2;
            return { translate: [tx, ty], scale: xScale }
        }

        function clicked(d, i) {


            // if (d3.event.defaultPrevented) {
            //     return; // panning, not clicking
            // }

            node = d3.select(this);
            console.log("node0: ", node[0][0])
            console.log(node)
            var circle = node[0][0]
            d3.select(circle)
                .attr("id", "selected")
                .attr("fill", "MediumSlateBlue")
            d3.selectAll("#selected")
            .append("circle")
            
                                

            console.log("HERE: ", circle)
            // circle.attr("id", "selected")
            var transform = getTransform(node, clickScale);
            console.log(transform)
            container.transition().duration(1000)
                .attr("transform", "translate(" + transform.translate + ")scale(" + transform.scale + ")");
            console.log("container: ", container)
            zoom.scale(transform.scale)
                .translate(transform.translate);
            console.log("zoom: ", zoom)
            scale = transform.scale;

            console.log("D in clicked: ", d)


        }


        function zoomed() {
            var translateX = d3.event.translate[0];
            var translateY = d3.event.translate[1];
            var xScale = d3.event.scale;
            container.attr("transform", "translate(" + translateX + "," + translateY + ")scale(" + xScale + ")");
        }

        function reset() {
            scale = 0.0;
            //console.log(data)
            createSymbolChart(data)
            //container.attr("transform", "translate(0,0)scale(1,1)");
            console.log(container)

            var transform = getTransform(container, clickScale)
            console.log(transform)

            console.log("here: ", transform.scale)
            container.transition().duration(1000)
                .attr("transform", "translate(" + [height, height] + ")scale(" + 1.0 + ")");
            console.log("container: ", container)

            zoom.scale(scale)
                .translate([0, 0])
                .translate([height, height]);
        }
        
    }// end of create Symbol Chart

    // function updateChart() {
    //         d3.select(".chart").remove();
    //         d3.select("h3").remove();
    //         d3.csv("titanic passenger list (2).csv", draw);
    //     };

    //     d3.selectAll(".input").on("click", updateChart);
    //     d3.csv("titanic passenger list (2).csv", draw); 
</script>


</body>

</html>